#!/bin/bash

echo "Running linter checks before commit..."

# Run ruff linter
ruff check .
if [ $? -ne 0 ]; then
    echo ""
    echo "❌ Commit rejected: Linting failed!"
    echo "Run 'ruff check --fix .' to auto-fix issues, or fix them manually."
    exit 1
fi
echo "✅ Linting passed!"

# Check formatting
ruff format --check .
if [ $? -ne 0 ]; then
    echo ""
    echo "❌ Commit rejected: Formatting issues found!"
    echo "Run 'ruff format .' to fix formatting."
    exit 1
fi
echo "✅ Formatting check passed!"

echo ""
echo "Running tests before commit..."

# Run pytest with coverage check and capture the exit code
python -m pytest tests/ --cov=. --cov-report=term-missing --cov-fail-under=99 -q

# Check if tests passed
if [ $? -ne 0 ]; then
    echo ""
    echo "❌ Commit rejected: Tests failed or coverage below 99%!"
    echo "Please fix the failing tests or improve coverage before committing."
    exit 1
fi

echo "✅ All tests passed!"
echo "✅ Coverage check passed (≥99%)!"
echo "✅ All pre-commit checks passed!"
exit 0
